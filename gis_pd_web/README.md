# GIS局部放电在线监测系统 - Web版

## 项目简介

本项目是GIS（气体绝缘开关柜）局部放电在线监测系统的Web版本，基于Python FastAPI框架开发。系统能够实时监测和显示GIS设备中的局部放电数据，支持PRPD（相位分辨局部放电）和PRPS（相位分辨脉冲序列）图表的实时显示和历史数据查询，是电力设备状态监测和故障预警的重要工具。

**重要特点**：本系统通过从SQLite数据库实时读取数据进行更新，而非直接连接传感器。系统使用WebSocket技术定期检查数据库中的新数据，并将其推送到前端进行可视化显示。这种设计使得Web版可以与桌面版应用程序共享同一数据源，实现数据的统一管理和多终端访问。

## 系统功能

### 1. 实时监测功能

- **实时数据显示**：通过WebSocket连接实时获取数据库中的最新周期数据
- **PRPD图表**：支持散点图和线图两种显示方式，可视化局部放电的相位-幅值分布
- **PRPS三维图**：显示最新50个周期的相位-周期-幅值三维分布
- **参考正弦波**：可选显示参考正弦波，辅助分析局部放电模式
- **单位转换**：支持mV和dBm单位切换，适应不同分析需求

### 2. 历史数据查询

- **最新数据查询**：查询指定数量的最新周期数据
- **时间范围查询**：根据起止时间查询特定时间段内的周期数据
- **历史PRPD图表**：查看历史数据的PRPD散点图或线图
- **历史PRPS图表**：查看历史数据的PRPS三维图表

### 3. 系统设置

- **数据更新间隔**：设置WebSocket数据更新的时间间隔
- **PRPD显示周期数**：设置PRPD图表显示的周期数量
- **PRPS颜色方案**：选择PRPS三维图的颜色方案（默认方案、蓝绿红、黑蓝紫、绿黄红）

## 系统架构

### 后端架构

- **Web框架**：FastAPI
- **数据库**：SQLite（gis_pd_data.db）
- **实时通信**：WebSocket
- **数据处理**：Python数据处理库（numpy等）

### 前端架构

- **基础技术**：HTML5 + CSS3 + JavaScript
- **2D图表**：Chart.js
- **3D图表**：Plotly.js
- **实时通信**：WebSocket API

### 数据库结构

- **cycle_data表**：存储周期数据
  - id：自增主键
  - timestamp：时间戳
  - cycle_number：周期编号
  - data：周期数据（以逗号分隔的字符串）

- **raw_data表**：存储原始数据
  - id：自增主键
  - timestamp：时间戳
  - broker：MQTT代理地址
  - topic：MQTT主题
  - raw_data：原始数据

### 数据流程

1. **数据源**：桌面版应用程序（gis_pd_mqtt_gui.py）通过MQTT接收传感器数据，并将处理后的数据存储到SQLite数据库中
2. **数据检测**：Web应用程序定期（默认每秒）检查数据库中是否有新的周期数据
3. **数据获取**：发现新数据时，Web应用从数据库中读取最新的数据记录
4. **数据推送**：通过WebSocket将新数据推送到已连接的客户端浏览器
5. **数据可视化**：前端JavaScript接收数据并更新PRPD和PRPS图表
6. **数据累积**：前端保持最新的50个周期数据用于PRPS三维图表显示

## 技术特点

### PRPD图表

- **数据处理**：将每个周期的数据点映射到0-360度的相位范围
- **散点图模式**：直观显示所有数据点的分布
- **线图模式**：清晰展示每个周期的波形变化
- **参考正弦波**：自适应振幅的正弦波，辅助分析放电模式

### PRPS三维图

- **固定显示50个周期**：始终显示最新的50个周期数据
- **数据累积**：实时接收数据时，保持并更新最新的50个周期
- **数据重采样**：对不同长度的周期数据进行线性插值，确保三维图表的规则网格
- **完全重绘机制**：使用Plotly.react完全重绘图表，确保数据显示的准确性
- **自定义颜色方案**：支持多种颜色方案，增强数据可视化效果

### 实时数据通信

- **WebSocket连接**：建立持久连接，减少通信延迟
- **增量数据更新**：只传输新增的数据，减少网络负载
- **数据累积处理**：前端累积并保持最新的50个周期数据
- **自动重连机制**：连接断开时自动尝试重新连接
- **数据库轮询**：后端定期检查数据库中的新数据，实现"伪实时"数据更新
- **数据ID跟踪**：使用last_data_id变量跟踪已处理的数据，避免重复处理

## 安装与运行

### 环境要求

- Python 3.7+
- 依赖库：见requirements.txt

### 安装步骤

1. 克隆或下载项目代码
2. 安装依赖库：
   ```
   pip install -r gis_pd_web/requirements.txt
   ```

### 运行方法

1. 进入项目目录
2. 运行Web应用：
   ```
   python gis_pd_web/run.py
   ```
3. 在浏览器中访问：http://localhost:8000

## 使用指南

### 实时监测

1. 打开系统首页，默认显示"实时监测"页面
2. 观察PRPD图和PRPS图的实时更新
3. 可通过控制面板调整图表类型、参考正弦波、单位等显示参数

### 历史数据查询

1. 点击导航栏的"历史数据"
2. 选择查询类型（最新数据或时间范围）
3. 输入查询参数（数据条数或时间范围）
4. 点击"查询"按钮
5. 选择图表类型（PRPD散点图、PRPD线图或PRPS三维图）查看结果

### 系统设置

1. 点击导航栏的"系统设置"
2. 调整数据更新间隔、PRPD显示周期数、PRPS颜色方案等参数
3. 点击"保存设置"应用更改

## 技术细节

### PRPS图表数据处理流程

1. 前端接收WebSocket传来的新周期数据
2. 将新数据添加到累积数据数组中
3. 保持最新的50个周期数据（如果超过50个则移除最早的数据）
4. 对所有周期数据进行处理：
   - 找出最大数据点数
   - 创建规则的相位网格
   - 对不同长度的周期数据进行线性插值
   - 创建Z值矩阵
5. 使用Plotly.react完全重绘三维图表

### 数据单位转换

- **毫伏(mV)转dBm**：`dBm值 = 毫伏值 * 54.545 - 81.818`
- **dBm转毫伏(mV)**：`毫伏值 = (dBm值 + 81.818) / 54.545`

## 故障排除

### 常见问题

1. **WebSocket连接失败**
   - 检查服务器是否正常运行
   - 检查网络连接是否正常
   - 查看浏览器控制台错误信息

2. **图表不显示或显示异常**
   - 检查是否有JavaScript错误（浏览器控制台）
   - 确认数据库中有足够的周期数据
   - 尝试刷新页面或重新连接WebSocket

3. **数据库连接错误**
   - 确认数据库文件路径正确
   - 检查数据库文件权限
   - 访问"/api/db_test"端点进行数据库诊断

## 开发与扩展

### 添加新的图表类型

1. 在前端HTML中添加图表容器
2. 在main.js中创建初始化和更新函数
3. 添加相应的控制元素和事件处理

### 修改数据处理逻辑

1. 在main.py中修改相应的API端点
2. 更新前端JavaScript中的数据处理函数

### 自定义PRPS颜色方案

1. 在main.js中的colorSchemes对象中添加新的颜色定义
2. 在HTML中的颜色方案选择器中添加新选项

## 版权与许可

© 2023 GIS局部放电在线监测系统 